---
title: "Travail V2"
author: "Patricia Côté, Samy Gallienne, Élodie Gravel, Pascale Laveault-Allard"
output:
  html_document:
    df_print: paged
jupyter:
  jupytext:
    formats: ipynb,Rmd
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.1
  kernelspec:
    display_name: R
    language: R
    name: ir
editor_options: 
  chunk_output_type: inline
---

Dans ce travail, nous proposons des ajustements au modèle de simulation de l'offre de travail au Québec à partir d'une étude publiée par des chercheurs de l'Université Laval en 2013. Le modèle est calibré avec les données du Labour Force Survey pour la province de Québec. Nous modélisons également les règles fiscales québécoises pour inclure les principaux transferts provinciaux et fédéraux. Nous utilisons ensuite ce modèle pour simuler l'effet de différentes réformes de la fiscalité québécoise sur l'offre de travail, le revenu des individus et la dispersion des revenus. Les trois réformes étudiées sont :

1. L'instauration d'un revenu minimum garanti 

2. La mise en place d'une prime à l'emploi 

3. Une combinaison des deux réformes 

Comme mentionné, les effets de ces réformes seront comparés sur la base de l'offre de travail, de la distribution des revenus dans la société et, si le temps et les données nous le permettent, l'effet en bref sur les finances publiques.


# 0. Chargement des librairies

```{r echo = T, results="hide"}
library(readr) # package pour lire les .csv
library(compiler) # package pour le Just-in-time compilation
library(DescTools) # Package pour le coefficient de Gini
library(vioplot) # Pour faire des beaux graphiques
library(knitr) # Pour rendre des beaux html
enableJIT(3) # Option du package compiler
set.seed(123) # Pour répliquer les résultats

```



# 1. Modèle d'offre de travail

## Préférences de l'individu

Nous supposons que les préférences des individus sont représentées par une fonction d'utilité de type log-log. La spécification des préférences de ce modèle est tirée d'une étude de Clavet, Duclos et Lacroix (https://www.utpjournals.press/doi/abs/10.3138/CPP.39.4.491) et adaptée en fonction des données disponibles:

$$ U(C_i,L_i) = \alpha_{1i}\ln(\bar{L}-L_i) +\alpha_2\ln(\bar{L}-L_i)^2+ \alpha_3\ln(C_i)+\alpha_4\ln(C_i)^2 + \gamma_0(L_i=0) + \gamma_f(L_i\in[1750,2000])$$

Où $C_i$ le niveau de consommation (le revenu disponible), $L_i$ est la quantité de travail (annuelle, en heures) et $\bar{L}$ est le nombre maximal d'heures qu'un individu peut travailler annuellement. Ainsi spécifié, le terme $\bar{L}-L_i$ est le nombre d'heures annuelles de loisir consommé par l'individu *i*. 

Le coefficient $\gamma_0$ permet d'inclure des coûts fixes au travail alors que le coefficient $\gamma_f$ permet de mettre une rigidité au travail à temps plein, défini entre 35 et 40 heures par semaine.

Toujours en s'inspirant de la proposition de Clavet, Duclos et Lacroix , l'hétérogénéité des préférences pour le loisir $\bar{L}-L$ est reflétée dans le paramètre $\alpha_{1i}$:
$$ \alpha_{1i} =\beta_0 + \beta_1\ln(age) + \beta_2\ln(age)^2 + \beta_3(prescolaire>0) + \beta_4~sexe + \beta_5~educ $$

Où *prescolaire>0* est une variable indicatrice égale à 1 si l'individu a au moins un enfant d'âge préscolaire à sa charge, *sexe* est une indicatrice égale à 1 si l'individu est une femme et *educ* reflète le niveau d'éducation. 

Pour coder la fonction d'utilité, la vecteur de coefficients pour les fonctions *Utilite* et *alpha1*, *theta*, est noté $\theta = (\beta_0, \beta_1, \beta_2, \beta_3, \beta_4, \beta_5, \alpha_2, \alpha_3, \alpha_4, \gamma_0, \gamma_f, \sigma_L)$ où $\sigma^2_L$ est l'écart-type des heures travaillées. .


```{r}
Utilite <- function(i,L,theta){
# Fonction d'utilité du travail et de la consommation
      util <- (alpha1(i,theta)*log(Lmax-L)+ theta[7]*log((Lmax-L)^2)+  theta[8]*log(Y(i,L)) + theta[9]*log((Y(i,L))^2)+ theta[10]*as.numeric(L==0) + theta[11]*as.numeric((L>=1750 & L<=2000)))
  return(util)
}

alpha1 <- function(i, theta){
    alpha1 <- (theta[1]+ theta[2]*log(age[i])+ theta[3]*log((age[i])^2)+ theta[4]*prescolaire[i]+ theta[5]*sexe[i] + theta[6]*educ[i])
  return(alpha1)
}
```

L'utilité est donnée par une fonction qui prend comme argument l'individu *i*, le nombre d'heures travaillées *L* et le vecteur de coefficients *theta*. Elle imbrique la fonction *alpha1* qui renvoie le coefficient $\alpha_{1i}$, le coefficient de préférence pour le loisir, en fonction des caractéristiques individuelles. *Lmax* est le nombre d'heures travaillées maximales $\bar{L}$.

## Contrainte budgétaire

La consommation (ou revenu disponible) est donnée par la contrainte budgétaire qui dépend du salaire horaire de l'individu $w_i$, de ses heures travaillées $L_i$ et de la fonction de taxation $t(\cdot)$:

$$
w_iL_i-t(w_iL_i)\geq C_i
$$

qui sera saturée à l'optimum. La fonction de taxation $t(w_iL_i)$ est une fonction non linéaire du revenu de travail brut.  $w_i$ est le salaire horaire pour chaque individu *i*. Le code R associé au revenu disponible, assumant que la contrainte budgétaire est serrée, est donné par:

```{r}
Y <- function(i,L){
  # Calcule la consommation nette (revenu disponible)
  dispo <- L*wage[i]-itax(L*wage[i],i)[1]
  #Empêche la fonction de rendre un nombre négatif
  Y<- max(1,dispo)
  return(Y)
}
```

La consommation est une fonction de l'individu *i* (son salaire) et du nombre d'heures travaillées *L*. Elle dépend aussi de la taxation du revenu par la fonction *itax*, qui sera définie à la section 2 sur les règles fiscales québécoises et canadiennes. 

## Maximisation sous contrainte

Pour maximiser l'utilité de l'individu, on peut substituer la contrainte budgétaire dans la fonction objectif:

$$ U(L_i) = \alpha_{1i}\ln(\bar{L}-L) +\alpha_2\ln(\bar{L}-L)^2+ \alpha_3\ln(w_iL_i-t(w_iL_i))+\alpha_4\ln(w_iL_i-t(w_iL_i))^2 + \gamma_0(L=0) + \gamma_f(L\in[1750,2000])$$

En supposant que *L* est une variable continue, que $t(\cdot)$ est différentiable, et que $\gamma_0=\gamma_f=0$, on peut prendre les conditions de premier ordre et réécrire le taux marginal de substitution entre le loisir $\bar{L}-L$ et la consommation $Y_i$:

$$
\frac{\bar{L}-L_i}{C_i}=\frac{\bar{L}-L_i}{w_iL_i-t(w_iL_i)}=\frac{\alpha_{1i}+2\alpha_2}{(\alpha_3+2\alpha_4)~w_i(1-t'(w_iL_i))}
$$

On voit donc que le $\alpha_{1i}$ permet à deux individus ayant le même salaire horaire $w_i$ d'avoir des taux marginaux de substitution entre le loisir et la consommation différents en fonction des caractéristiques de ces individus. 

Cependant, nous supposons ici un modèle d'offre de travail à choix discrets, comme dans l'étude de Clavet, Duclos et Lacroix. En effet, les individus, en réalité, ne peuvent ajuster leurs heures de travail que de façon discrète (des heures entières). Puisque ce sont des heures annuelles, ce n'est pas une hypothèse très forte. La fonction suivante évalue l'utilité pour différents choix d'heures de travail:

```{r}
umarginal <- function(i,incr,theta){
# calcule l'utilite marginale de l'individu i par increments de incr heures de travail
  lsup <- seq(0,Lmax,by=incr) # vecteur des heures travaillees
  util <- sapply(lsup,function(x) Utilite(i,x,theta)) # evalue l'utilite pour chaque niveau d'heures travaillees
  util2 <- c(util[2:(length(util))],0) # decale le vecteur des utilites
  deltautil <- util2-util # utilite marginale
  return(list(lsup[1:length(lsup)-1],deltautil[1:length(lsup)-1],util[1:length(lsup)-1]))
}
```


La fonction prend comme arguments l'individu *i*, la variation discrète annuelle des heures qu'il est possible de travailler *incr*, le vecteur de préférences individuelles *beta* et le vecteur de paramètres de la fonction d'utilité *theta*. La fonction retourne une liste de trois éléments. Premièrement, *lsup*, le vecteur des heures travaillées auxquelles la fonction est évaluée. Deuxièmement, *deltautil* est l'utilité marginale entre $L$ et $L+1$ heures travaillées. Troisièmement, *util* est l'utilité évaluée à chaque valeur de *lsup*. Le nombres d'heures optimales travaillées *Loptimal* est simplement la valeur de *L* qui est associée à la plus grande utilité:

```{r}

Loptimal <-function(i,incr, theta){
  #vecteur des utilités pour chaque heure de travail  
  u <- as.numeric(umarginal(i,incr,theta)[[3]]) 
  lsup <- as.numeric(umarginal(i,incr,theta)[[1]]) 
  # heures minimales travailles qui maximisent l'utilite
  position <- which(u==max(u)) #utilite maximale
  h<-min(lsup[position])
  return(h) 

}
```

Voici un jeu de données fictives (10 observations) sur lesquelles nous avons testé les fonctions (sans taxes ni transferts)

```{r fig6, fig.height=4, fig.width=5}
#Fonction de taxation temporaire: aucune taxe
itax<- function(inc,i){
  return(0)
}

#Vecteurs de coefficients arbitraires
Lmax=4000
lincr=100
theta <- c(1, -1, 1, 1, -1, 1, 1 , 1, 1, 1, 1, 1)


#Données aléatoires
#Enlever le seed pour voir plusieurs tirages et le graphique s'adapter
wage      <-   sample(12:150, 10, replace = TRUE)
age      <-    sample(20:80, 10, replace = TRUE)
prescolaire <- sample(0:1, 10, replace = TRUE)
sexe  <-       sample(0:1, 10, replace = TRUE)
educ <-        sample(0:6, 10, replace = TRUE)

#Nombre d'individus
n<-10
Lopt<- rep(0, n)

for (i in 1:n) {
  Lopt[i] <- Loptimal(i, lincr, theta)
}

hist(Lopt, 
     main="Heures optimales simulées", 
     xlab="Heures de travail annuelles", 
     ylab="Fréquences", 
     xlim=c(0,4000),
     las=1, 
     breaks=10)
```

Dans cet exemple, les individus ne peuvent pas travailler 0 heures et n'avoir aucun revenu *Y=0* car *ln(0)* n'est pas défini. Les heures simulées dépendent fortement des paramères arbitraires postulés. Dans ce cas hypothétique, nous avons posé que tous les intrants de la fonction d'utilité ont un effet égal à un, sauf l'âge et le fait d'être une femme qui diminuent la préférence pour le loisir. La modification de ces coefficients affecte la distribution des heures de travail simulée dans cette cohorte.



# 2. Règles fiscales appliquées

## Paliers d'imposition provinciaux et fédéraux

Nous allons utiliser les taux de taxe et paliers suivants:

```{r}
  # source1: http://www.nrgcpa.ca/deductions-a-la-source-et-charges-sociales
  # source2: http://www4.gouv.qc.ca/FR/Portail/Citoyens/Evenements/immigrer-au-quebec/Pages/programme-aide-sociale.aspx
  # source3 :https://www.canada.ca/fr/agence-revenu/services/impot/particuliers/foire-questions-particuliers/taux-imposition-canadiens-particuliers-annee-courante-annees-passees.html#federal 

  # taux de taxe QC
  pp1 <- 0.15
  pp2 <- 0.2
  pp3 <- 0.24
  pp4 <- 0.2575

  # seuils de taxation QC
  p1 <- 15532
  p2 <- 44545
  p3 <- 89080
  p4 <- 108390

  # taux de taxe CAN
  pt1 <- 0.15
  pt2 <- 0.2050
  pt3 <- 0.26
  pt4 <- 0.29
  pt5 <- 0.33

  # seuils de taxation CAN
  f1 <- 12298
  f2 <- 48535
  f3 <- 97069
  f4 <- 150473
  f5 <- 214368
  
```
Pour continuer, nous posons que l'aide sociale (*asc*) existe (elle est égale à 1), et qu'il y a 50 semaines de travail dans une année.

```{r}
asc <- 1
weeks <- 50 #nombre d'heures par année

```

## Transferts

La liste des principaux transferts fédéraux et provinciaux est tirée de l’étude «TAUX MARGINAUX EFFECTIFS D’IMPOSITION : UNE COMPARAISON QUÉBEC-ONTARIO » de Blancquaert, Clavet, Duclos, Fortin et Marchand (2017). Nous supposons l’impact d’utilisation des transferts énumérés dans cet article et négligeons l’impact des autres crédits d’impôt disponibles plus spécifiques aux différentes situations des ménages, dont nous jugeons l’impact moindre pour la complexification que leur analyse apporte. La plupart des transferts dépendent du type de ménage. Pour les ménages avec enfants, nous avons supposé un nombre de 1 enfant par ménage en raison du faible taux de natalité. Comme le LFS est une enquête sur les individus et non sur les ménages, les transferts destinés à des couples ont été divisés par deux afin de ne pas distribuer en double les montants. Les transferts initiaux sont activés lorsque reforme = 0.

Les abréviations suivantes ont été utilisées : 

* *ps* : personne seule

* *c* : couple sans enfants

* *fm* : famille monoparentale

* *ce* : couple avec enfants

```{r}
#la variable reforme indique quel scenario utiliser. reforme = 0 est le scenario de base

reforme <- 0

transferts <- function(inc, i){
  
  #Credit TPS-TVH
  #sources des donnees :  https://cffp.recherche.usherbrooke.ca/outils-ressources/guide-mesures-fiscales/credit-impot-tps-tvh/
  
  TPS_TVH <- 296 # montant de base
  
  if (c[i] == 1 | ce[i] == 1 | fm[i] == 1) { 
    TPS_TVH <- TPS_TVH + 296 # montant si personne a charge ou monoparental
    if (ce[i] == 1) {
      TPS_TVH <- TPS_TVH + 155 # montant si couple a un enfant
    }
  }
  if (ps[i] == 1) {
    TPS_TVH <- TPS_TVH + min(155, max(0, 0.02*(inc-9590))) # montant pour celibataire
  } else if (fm[i] == 1) {
    TPS_TVH <- TPS_TVH + 155 # montant supplementaire celibataire applicable au parent monoparental
  }
  if (inc > 38507) {
    TPS_TVH <- max(0, TPS_TVH - 0.05*(inc-38507))  # reduction de 5% du credit a partir d'un revenu superieur a 38507
  } 
  if (c[i] == 1 | ce[i] == 1 ) { 
    TPS_TVH <- TPS_TVH / 2  # montant final divise par 2 si en couple car une seule personne par couple peut avoir le transfert
  }
  
  
  #Prime au travail 
  # Par simplification, nous utilisons les parametres de base et n'ajoutons pas la prime pour personne handicapee.
  
  # Sources des donnees : https://www.revenuquebec.ca/fr/citoyens/credits-dimpot/credits-dimpot-relatifs-a-la-prime-au-travail/
  # Bonifie le revenu de travail d'un % à partir d'un seuil, puis diminue de 10% à partir d'un second seuil 
  if (ps[i] == 1){
    if (inc > 2400 & inc < 19456) {  # celibataire
      PrimeTravail <- min(874, 0.105*(inc-2400)) - max(0, 0.1*(inc-10720))
    } else {
      PrimeTravail <- 0
    }
  } else if (fm[i] == 1){
    if (inc > 2400 & inc < 36680){ # monoparental
      PrimeTravail <- min(2496, 0.30*(inc-2400)) - max(0, 0.1*(inc-10720))
    } else {
      PrimeTravail <- 0
    }
  } else if (c[i] == 1){
    if (inc > 3600 & inc < 30217){ # couple
      PrimeTravail <- (min(1363, 0.105*(inc-3600)) - max(0, 0.1*(inc-16584))) / 2 # divise en 2 pour couple
    } else {
      PrimeTravail <- 0
    }
  } else if (ce[i] == 1){
    if (inc > 3600 & inc < 49044){ # couple avec enfant
      PrimeTravail <- (min(3246, 0.25*(inc-3600)) - max(0, 0.1*(inc-16584))) / 2 # divise en 2 pour couple
    } else {
      PrimeTravail <- 0
    }
  } # les valeurs pour 2019 ont ete utilisees

  #Allocation canadienne pour les travailleurs
  #Source des donnees : https://cffp.recherche.usherbrooke.ca/outils-ressources/guide-mesures-fiscales/allocation-canadienne-pour-les-travailleurs/ 
  if (ps[i] == 1){
    if (inc > 2400 & inc < 23458){ # celibataire
      AllocationTravailleur <- min(2280, 0.274*(inc-2400)) - max(0, 0.2*(inc-12060)) # L'allocation diminue de 20% apres un seuil de revenu.
    } else {
      AllocationTravailleur <- 0
    }
  } else if (fm[i] == 1){
    if (inc > 2400 & inc < 18305){ # monoparental
      AllocationTravailleur <- min(1248, 0.15*(inc-2400)) - max(0, 0.2*(inc-12065))
    } else {
      AllocationTravailleur <- 0
    }
  } else if (c[i] == 1){
    if (inc > 3600 & inc < 36308){ # couple
      AllocationTravailleur <- (min(3558, 0.274*(inc-3600)) - max(0, 0.2*(inc-18520))) / 2
    } else {
      AllocationTravailleur <- 0
    }
  } else if (ce[i] == 1){
    if (inc > 3600 & inc < 27629){ # couple avec enfant
      AllocationTravailleur <- (min(1818, 0.14*(inc-3600)) - max(0, 0.2*(inc-18540))) / 2
    } else {
      AllocationTravailleur <- 0
    }
  }
  
  #Allocation canadienne pour enfants
  # Source des donnees : https://cffp.recherche.usherbrooke.ca/outils-ressources/guide-mesures-fiscales/allocation-canadienne-enfants/
  if (ce[i] == 1 | fm[i] ==1){   # Aucune distinction entre famille monoparentale et couple
    if (prescolaire[i] == 1) {
      ACE <- 6765 # montant plus eleve si enfant à moins de 6
    } else {
      ACE <- 5708 # on suppose qu'il n'y a qu'un seul enfant
    }
    if (inc > 31711) { # premier seul de reduction (marginal)
      ACE <- ACE - 0.07*min(36997, inc - 31711) #  #Diminution de 7% pour revenu entre 31711 et 68708
    }
    if (inc > 68708) {  # Deuxième seuil de réduction
      ACE <- ACE - 0.032*(inc - 68708) # Diminution de 3,2% pour revenu superieur a 68708
    }
    ACE <- max(ACE, 0) # on s'assure que la valeur n'est pas negative
    if (ce[i] == 1) {
      ACE <- ACE/2 # on divise le montant pas deux pour un couple
    }
  } else {
      ACE <- 0 #aucune allocation si pas d'enfant
  }
  
  
  #Allocation famille
  # Source des donnees : https://cffp.recherche.usherbrooke.ca/outils-ressources/guide-mesures-fiscales/allocation-famille-soutien-enfants/
  # Utilisation des données pour l'annee 2020
  # Par simplification du modele, nous avons decide un maximum de 1 enfant par famille sans handicape ou soins exceptionnels.
  if (fm[i] == 1) {
    AllocationFamille <- 2515 + 882 # prime de base plus prime pour monoparental
    if (inc > 36256) {
      AllocationFamille <- AllocationFamille - 0.04*(inc-36256) # deduction pour haut revenu
    }
    AllocationFamille <- max(AllocationFamille, 1352) # prime minimum
  } else if (ce[i] == 1) {
    AllocationFamille <- 2515 # montant de base pour un enfant
    if (inc > 49842) {
      AllocationFamille <- AllocationFamille - 0.04*(inc-49842) # deduction pour haut revenu
    }
    AllocationFamille <- max(AllocationFamille, 1000) / 2 # prime minimum, divisee par 2
  } else {
    AllocationFamille <- 0
  }
  
  #Credit solidarite
  # Par fin de simplification, les composantes relatives aux villages nordiques on ete ignores. De plus, un seul scenario de base a ete effectue par type de menage.
  
  # Sources des donnees : http://www4.gouv.qc.ca/FR/Portail/Citoyens/Evenements/acheter-renover-maison/Pages/credit-impot-pour-solidarite.aspx  et https://cffp.recherche.usherbrooke.ca/outils-ressources/guide-mesures-fiscales/credit-impot-solidarite/ 
  if (ps[i] == 1) {
    CreditSolidarite <- 297+141+(577) # montant de base
    if (inc > 35400) { # deduction pour revenu eleve
      # montant verse ne peut pas etre inferieur à 0 ou au montant de la composante TVQ
      CreditSolidarite <- max(0, 297 + 141 - 0.03*(inc-35400),  CreditSolidarite - 0.06*(inc-35400))
    } 
  } else if (fm[i] == 1) { 
    CreditSolidarite <- 297+141+(577+123) # montant de base
    if (inc > 35400) { # deduction pour revenu eleve
      # montant versé ne peut pas être inferieur à 0 ou au montant de la composante TVQ
      CreditSolidarite <- max(0, 297 + 141 - 0.03*(inc-35400),  CreditSolidarite - 0.06*(inc-35400))
    } 
  } else if (c[i] == 1) {
    CreditSolidarite <- 297+297+(699) # montant de base
    if (inc > 35400) { # deduction pour revenu eleve
      # montant verse ne peut pas etre inferieur à 0 ou au montant de la composante TVQ
      CreditSolidarite <- max(0, 297 + 297 - 0.03*(inc-35400),  CreditSolidarite - 0.06*(inc-35400))
      # divise par 2 pour un couple
    }
    CreditSolidarite <- CreditSolidarite / 2
  } else if (ce[i] == 1) {
    CreditSolidarite <- 297+297+(699+123) # montant de base
    if (inc > 35400) { # deduction pour revenu eleve
      # montant verse ne peut pas etre inferieur à 0 ou au montant de la composante TVQ
      CreditSolidarite <- max(0, 297 + 297 - 0.03*(inc-35400),  CreditSolidarite - 0.06*(inc-35400))
      # disive par 2 pour un couple
    }
    CreditSolidarite <- CreditSolidarite / 2
  }
  

  # Reforme #1: Prime a l'emploi
# Inspirée d'une des options analysées par Clavet et al. (2013) Source : https://www.utpjournals.press/doi/abs/10.3138/CPP.39.4.491
  
  if ((inc / wage[i])>30*weeks) {
    PrimeEmploi <- (inc/wage[i]-(30*weeks))*3 
  } else {
    PrimeEmploi <- 0 
  }
  

  # Reforme #2: Revenu minimum garanti
  # Representation la recommandation 9 du rapport du revenu minimum garanti (2017) Source : https://www.mtess.gouv.qc.ca/grands-dossiers/revenu_min_garanti.asp 
  # Souces pour le montant du calcul du panier de consommation : 
      # https://www150.statcan.gc.ca/t1/tbl1/fr/tv.action?pid=1110006601
      # https://www150.statcan.gc.ca/t1/tbl1/fr/tv.action?pid=1110022401 
      # https://www150.statcan.gc.ca/t1/tbl1/fr/tv.action?pid=1810000413
      
  panier <- 36970.44 # panier de consommation pris pour Montreal car le plus eleve de la province
  
  if (age[i] > 1 & age[i] < 11) {
    rmg <- panier * 0.55 # 55 % du panier pour personne entre 20 et 65 ans 
  } else if (age[i] > 10) {
    rmg <- panier  # 100% de la valeur du panier de consommation pour une personne de 65 ans et plus
  } else {
    rmg <- 0 # 0 si moins de 20 ans
  }
    
  if (ps[i] == 1) {
    rmg <- rmg
  } else if (fm[i] == 1) {
     rmg <- rmg*1.45  # ajustement pour situation familiale, estimations des depenses d'une famille monoparentale a 145% des depenses d'une personne seule

  } else if (c[i] == 1) {
     rmg <- rmg*1.87/2  # ajustement pour situation familiale, estimation des depenses d'un couple a 187% des depenses d'une personne seule
     
  } else if (ce[i] == 1) {
     rmg <- rmg*2.48/2  # ajustement pour situation familiale, estimation des depenses d'un couple avec enfant a 248% des depenses d'une personne seule
  }
#divise par deux dans le cas des couples (avec et sans enfant) pour avoir le montant obtenu par chaque personne

  if (reforme == 0) {
    assign("asc", 1, envir = .GlobalEnv)
    transferts <- TPS_TVH + AllocationTravailleur + ACE + AllocationFamille + CreditSolidarite + PrimeTravail
  } else if (reforme == 1) {
    assign("asc", 1, envir = .GlobalEnv)
    transferts <- TPS_TVH + AllocationTravailleur + ACE + AllocationFamille + CreditSolidarite + PrimeEmploi
  } else if (reforme == 2) {
    assign("asc", 0, envir = .GlobalEnv)
    transferts <- rmg
  } else if (reforme == 3 ) {
    assign("asc", 0, envir = .GlobalEnv)
    transferts <- rmg + PrimeEmploi
  }

  return(transferts)
}
```

## Calcul du revenu net

L’impôt est calculé selon la combinaison des paliers d'imposition fédéraux et provinciaux. Nous calculons le montant d’impôt prélevé sur le revenu avec la variation subie entre chaque palier d’imposition. Dans un but de simplification, nous ignorons la réforme de la CAQ concernant la taxation des heures supplémentaires travaillées.
```{r}

itax <- function(inc,i){
  # Calcule les impots sur le revenu
   
  if (inc<=f1){
    prv <- 0
    fed <- 0
  }
  if (inc>f1 & inc<=p1){
    prv <- 0
    fed <- pt1*(inc-f1)
  }
  if (inc>p1 & inc<=p2){
    prv <- pp1*(inc-p1)
    fed <- pt1*(inc-f1)
  }
  else if (inc>p2 & inc<=f2){
    prv <- pp1*(p2-p1) + pp2*(inc-p2)
    fed <- pt1*(inc-f1)
  }
  else if (inc>f2 & inc<=p3){
    prv <- pp1*(p2-p1) + pp2*(inc-p2)
    fed <- pt1*(f2-f1) + pt2*(inc-f2)
  }
  else if (inc>p3 & inc<=f3){
    prv <- pp1*(p2-p1) + pp2*(p3-p2) + pp3*(inc-p3)
    fed <- pt1*(f2-f1) + pt2*(inc-f2)
  }
  else if (inc>f3 & inc<=p4){
    prv <- pp1*(p2-p1) + pp2*(p3-p2) + pp3*(inc-p3)
    fed <- pt1*(f2-f1) + pt2*(f3-f2) + pt3*(inc-f3)
  }
  else if (inc>p4 & inc<=f4){
    prv <- pp1*(p2-p1) + pp2*(p3-p2) + pp3*(p4-p3) + pp4*(inc-p4)
    fed <- pt1*(f2-f1) + pt2*(f3-f2) + pt3*(inc-f3)
  }
  else if (inc>f4 & inc<=f5){
    prv <- pp1*(p2-p1) + pp2*(p3-p2) + pp3*(p4-p3) + pp4*(inc-p4)
    fed <- pt1*(f2-f1) + pt2*(f3-f2) + pt3*(f4-f3) + pt4*(inc-f4)
  }
  else if (inc>f5){
    prv <- pp1*(p2-p1) + pp2*(p3-p2) + pp3*(p4-p3) + pp4*(inc-p4)
    fed <- pt1*(f2-f1) + pt2*(f3-f2) + pt3*(f4-f3) + pt4*(f5-f4) + pt5*(inc-f5)
  }
  
  aemploi <- min(54200,inc)*0.012
  rrq <- 0 #max(min(58700,inc)-3500,0)*0.057
  rqap <- min(78500,inc)*0.00494
  
  asociale <- max(690*12 - max(inc-200*12,0),0)*as.numeric(asc)
  tax <-  prv + fed + aemploi + rrq + rqap - asociale -transferts(inc,i)
  
  return(c(tax,prv,fed,aemploi,rrq,rqap,asociale, transferts(inc,i)))
}
```

Cette fonction de taxe prend en compte les paliers d'imposition fédéraux (*fed*) et québécois (*prv*), ainsi que les contributions à l'assurance emploi (*aemploi*), au RQAP (*rqap*) et, finalement, au programme d'aide sociale (*asociale*). Notez que nous n'avons pas inclus la contribution au RRQ puisque nous supposons qu'il s'agit uniquement d'un lissage intertemporel de la consommation des individus et, du même fait, n'affecte pas leur revenu permanent. 


## Taux marginaux effectifs d'imposition

On peut directement voir l'impact de la fonction de taxe, sans hypothèses sur le comportement des individus, en regardant les taux marginaux effectifs d'imposition (TMEI). Le code suivant crée un graphique pour des incréments salariaux annuels de *incr* jusqu'à un revenu annuel de *imax* \$ pour chacun des 4 types de ménages (personne seule (ps), couple (c), famille monoparentale (fm) et couple avec enfants (ce)).

```{r fig11}
tme <- function(incr,imax,i){
  # calcule les taux marginaux effectifs d'imposition par increments de "incr"$, jusqu'a imax$
  incm <- seq(0,imax,by=incr) # vecteur des niveaux de revenus
  tax <- sapply(incm,function(x) itax(x,i)[1]) # applique la taxe sur chaque niveau de revenu
  tax2 <- c(tax[2:(length(tax))],0) # decale le taux de taxe
  deltatax <- tax2-tax # taxe marginale
  tm <- deltatax/incr # taux marginal effectif
  plot(incm[1:length(incm)-1],tm[1:length(incm)-1],xlab='Revenu annuel', ylab='TMEI', ylim=c(0, 1))
  return(list(incm[1:length(incm)-1],tm[1:length(incm)-1]))
}

# graphique des TMEI par type de menage, suppose des enfants <6 ans
ps<- c(1,0,0,0)
c <-  c(0,1,0,0)
fm <- c(0,0,1,0)
ce <- c(0,0,0,1)
prescolaire <- c(0,0,1,1)

for (i in 1:4) {
  tme(100,250000,i)  
}

```

# 3. Données du *Labour Force Survey*

Pour cette analyse, nous allons utiliser les données du *Labour Force Survey* pour la province de Québec (*PROV=24*). Afin de ne pas inclure les effets exogènes sur l'économie dus au COVID-19, nous avons téléchargé les données de février 2020. 

Voici une table détaillant les variables extraites:

|Nom de la variable *LFS*|Description|Nom abrégé|
|-|-|-|
|AGE_12|Âge regroupé en 12 tranches de 5 ans (1=15-19 ans; 2=20-24; 3=25-29; 4=30-34; 5=35-39; 6=40-44, 7=45-49; 8=50-54; 9=55-59; 10=60-64; 11=65-69; 12=>70)|age|
|SEX|Égal à 1 si l'individu est une femme|sexe|
|EDUC|Niveau le plus élevé d'études atteint (1=0-8 ans; 2=Éduaction secondaire quelconque; 3=Secondaire complété; 4=certificat ou diplome postsecondaire; 5=Baccalauréat; 6=Études supérieures)|educ|
|AGYOWNK|Âge de l'enfant le plus jeune (1=<6ans; 2=6-12; 3=13-17; 4=18-24)|prescolaire|
|EFAMTYPE|Type de ménage (1,15,17,18=Célibtaire; 2,4,5,7,8,10,11,13=Couple; 3,6,9,12= Couple avec enfant(s), 14,16=Ménage monoparental)|ps, c, fm et ce|
|SCHOOLN|Statut d'étudiant (1=non-étudiant; 2=Temps plein; 3=Temps partiel)|etudes|
|ATOTHRS|Nombre d'heures hebdomadaires travaillées|heures|
|HRLYEARN|Salaire horaire de l'employé|wage|
|FINALWT|Poids de l'individu dans l'échantillon|wght|




## Chargement des données
Les données contiennent un total de 17865 observations. Nous retirons les étudiants car leur offre de travail ne serait pas compatible avec le modèle théorique postulé. Pour ce faire, nous leur assignons une valeur manquante dans la colonne `SCHOOLN` afin que ces individus soient supprimés par la commande `complete.cases`. Cette dernière enlève les valeurs manquantes. Il y a 1116 ménages dans les données pour lesquels l'âge des enfants est manquant, ce qui devient plus problématique pour l'allocation canadienne pour enfants, qui varie selon l'âge des enfants. Dans un objectif de simplification, ces données ont été supprimées de la base de données initiale. En enlevant ces observations qui ont des valeurs manquantes, nous prenons soin de conserver leurs poids afin de repondérer les autres individus. Pour les tests, nous avons tiré un échantillon de 1000 individus. L’analyse finale a été effectuée sur l’ensemble des observations. Dans les deux cas, nous avons également noté n le nombre d’individus dans l’échantillon courant.

```{r}
lfs <- read_csv("./LFS-71M0001-E-2020-February_F1.csv", col_types = cols()) # importe les données du LFS, Février 2020
lfsqc <- lfs[lfs$PROV==24,] # Garde uniquement le Québec
rm(lfs) # Supprime la base initiale de la mémoire
lfsqc <- lfsqc[,c("AGE_12","SEX","EDUC","ATOTHRS","HRLYEARN","EFAMTYPE","SCHOOLN","AGYOWNK","FINALWT")]  # Garde seulement certaines variables

# Si menage n'a pas d'enfant, alors l'age du plus jeune est redéfini à zéro au lieu d'être manquante 
# Ceci est fait afin de ne pas jetter ces observations 
lfsqc$AGYOWNK <- ifelse(lfsqc$EFAMTYPE %in% c(1,15,17,18,2,4,5,7,8,10,11,13) & is.na(lfsqc$AGYOWNK), 0, lfsqc$AGYOWNK)

# Enlever les étudiants
lfsqc$SCHOOLN[lfsqc$SCHOOLN != 1] <- NA
n0 <- nrow(lfsqc) # Garde le nombre d'observations initiales
missingweight <- c(lfsqc[!complete.cases(lfsqc),"FINALWT"])[[1]] #Garde les poids des individus qui seront enlevés
lfsqc <- lfsqc[complete.cases(lfsqc), ] # Enlève les observations avec des variables manquantes
#lfsqc <- lfsqc[sample(1:nrow(lfsqc), 1000, replace=FALSE),] # Sous-échantillonage pour les tests (commenté pour l'analyse finale, décommenter pour compilation plus rapide)
n <- nrow(lfsqc) # Nombre d'individus dans la base

# Ajustement des poids des individus
corfact <- sum(lfsqc$FINALWT)/(sum(lfsqc$FINALWT)+sum(missingweight))
wght <- as.numeric(lfsqc$FINALWT)/corfact # Calcule les poids approximatifs (les val. manquantes sont parfaitement aléatoires)
```

À partir d'une base de données complète (sans valeurs manquantes), nous créons des vecteurs pour les variables du modèle théorique et celles essentielles à la modélisation des règles fiscales québécoises et canadiennes. Les données sont conservées en vecteurs séparés pour faciliter leur utilisation dans les différentes fonctions programmées. L'ensemble des variables explicatives est rassemblé dans la matrice *Xmat* afin de décrire rapidement l'ensemble des variables. 

```{r}

# Créer des vecteurs de variables
wage <- as.numeric(lfsqc$HRLYEARN) # salaire horaire
age <- as.numeric(lfsqc$AGE_12) # âge regroupé en tranches de 5 ans de 15-19 ans(1) a >70 (12)
sexe <- ifelse(lfsqc$SEX == 1, 1, 0) # Code les femmes = 1, hommes =0
prescolaire <- ifelse(lfsqc$AGYOWNK == 1, 1, 0) # enfant le plus jeune <6 ans, 1= oui, 0=non
educ <- as.numeric(lfsqc$EDUC) #niveau d'éducation
#Type de ménage
#Personnes seules
ps<-ifelse(lfsqc$EFAMTYPE %in% c(1,15,17,18), 1,0)

#Couples sans enfants
c <- ifelse(lfsqc$EFAMTYPE %in% c(2,4,5,7,8,10,11,13), 1,0)

#Familles monoparentales
fm <- ifelse(lfsqc$EFAMTYPE %in% c(14,16), 1,0)

#Couples avec enfants (<18 ans)
ce <- ifelse(lfsqc$EFAMTYPE %in% c(3,6,9,12), 1,0)

#Matrice de covariables en ajoutant une constante de 1
constante <- rep(1,n)
Xmat <- as.data.frame( cbind(constante,age, sexe, educ,prescolaire, ps, c, fm, ce ))
```

## Statistiques descriptives

Voici un résumé des caractéristiques démographiques de l'échantillon :

```{r}
# résumé des variables démographiques

kable(summary(Xmat) )
```

Voici la distribution des heures travaillées et des salaires horaires:

```{r fig15, fig.width=8, fig.height=4}
par(mfrow=c(1,2))
hist(wage,
    main="Distribution des salaires", 
     xlab="Salaire horaire - Dollars canadiens", ylab = "Fréquence")
hist(lfsqc$ATOTHRS,
    main="Distribution des heures travaillées", 
     xlab="Nombre d'heures hebdomadaires", ylab = "")
```


## Effet des taxes

```{r fig16, fig.width=5, fig.height=3}
rhours <- as.numeric(lfsqc$ATOTHRS)*weeks
salbrut <- rhours*wage

salnet<- rep(n,0)
for (j in 1:n) {
  salnet[j] <- Y(j, rhours[j])
}

# Couleurs transparentes pour les graphiques
bleupale<-rgb(0,0,1,0.5)
bleumoyen <-rgb(0,1,1,0.5)

hist(salbrut,col=bleupale,
    main="Distribution du revenu brut et net", 
     xlab="Revenu annuel ($)", ylab = "Fréquence", xlim = c(0, 250000))
hist(salnet, add=TRUE , col=bleumoyen)
legend("right", legend=c("Revenu brut", "Revenu net"),
       fill=c(bleupale, bleumoyen), cex=0.8)

```


# 4. Calibration

## Variables globales

Les variables globales sont définies comme suit:

* *Lmax* est le nombre maximal d'heures qu'il est possible de travailler par année. Nous l'avons fixé à 4250 heures, soit 85 heures par semaine.

* *weeks* est le nombre de semaines de travail par année, fixé à 50.

* *lincr* est le nombre minimal d'heures annuelles de travail que l'individu peut ajuster. Nous l'avons fixé à 250 heures par année, soit des incréments de 5 heures par semaine.

* *nincr* est le nombre d'incréments (le nombre de sauts) possibles. 

* *nsim* est le nombre de simulations que nous allons faire pour ajouter des termes d'erreurs dans le modèle. Nous l'avons fixé à 10. Un nombre trop faible induit des risques que les erreurs induisent trop de *bruit* dans les données et un nombre trop élevé allonge la durée de compilation du code. Nous suggérons de le poser à 1 pour une compilation plus rapide.   

```{r}
Lmax <- 4250
weeks <- 50
lincr <- 250
nincr <- Lmax/lincr +1
nsim <- 10
```


## Processus aléatoires

Pour calibrer le modèle d'offre de travail, nous allons utiliser les données sur les heures travaillées disponibles dans le *Labour Force Survey*. Comme il y a toujours une variabilité dans les données qui ne peut être captée par le modèle théorique, nous ajoutons des processus aléatoires au modèle spécifié plus haut. Pour ce faire, nous supposons des caractéristiques inobservables des individus qui rendent aléatoire la fonction de préférence pour le loisir:

$$\hat{\alpha_{1i}} = \alpha_{1i}+e^{v_i}$$
où *v* est un terme aléatoire normalement distribué (i.i.d) de moyenne zéro et variance 0.01. La transformation $e^{v_i}$ empêche d'avoir une valeur négative de $\hat{\alpha}_{1i}$

La matrice *erreurA* pour le coefficient $\hat{\alpha_{1i}}$ contient un terme d'erreur pour chaque individu à chaque simulation et est construite par le code suivant:

```{r}
erreurA <- matrix(rnorm(n*nsim,0,0.01), nsim, n)
```

Nous supposons aussi que la fonction d'utilité elle-même a un terme d'erreur $\epsilon_{i,L}$:

$$\hat{U}_i(C,L)=U_i(C,L)+\theta_{12}e^{\epsilon_{i,L}},$$

où $\epsilon_{i,L}$ est également un terme aléatoire normalement distribué (i.i.d) de moyenne zéro et d'écart-type 1 pour chaque tranche d'heures travaillées pour chaque individu. Encore une fois, la transformation $e^{\epsilon_{i,L}}$ assure une valeur positive du terme d'erreur et par le fait même, que la fonction d'utilité demeure positive. Le paramètre $\theta_{12}$ modifie l'ampleur du terme d'erreur afin d'ajuster l'écart-type des heures simulées à celui des heures observées. 

```{r}
erreurU <- replicate(n, matrix(rnorm((nincr)*nsim,0,1), nrow=nincr, ncol=nsim))
```

Dans ce cas, nous re-codons les fonctions *alpha1*, *Utilite* et *umarginal* et *Loptimal* pour quelles incluent les termes d'erreur. 

```{r}
alphahat<- function(i,theta, sim){
  alphahat <- as.numeric(alpha1(i, theta)) +exp(erreurA[sim,i])
  return(alphahat)
}

uhat <- function(i, L, theta, sim){
  uhat <- (alphahat(i,theta, sim)*log(Lmax-L)+ theta[7]*log((Lmax-L)^2)+theta[8]*log(Y(i,L)) + theta[9]*log((Y(i,L))^2)+ theta[10]*as.numeric(L==0)+theta[11]*as.numeric((L>=1750 & L<=2000)))
return( uhat)
}

umarghat <- function(i,theta, sim){
# calcule l'utilite marginale de l'individu i par increments de incr heures de travail
  lsup <- seq(0,Lmax,by=lincr) # vecteur des heures travaillees
  util <- sapply(lsup,function(x) uhat(i,x,theta,sim))+ exp(as.numeric(erreurU[,sim,i]))*theta[12]
  return(list(lsup,util))
}


#nombre d'heures optimales
Lhat <- function(i, theta, sim){
  #vecteur des utilites pour chaque heure de travail  
  u <- as.numeric(umarghat(i, theta, sim)[[2]])
  lsup <- as.numeric(umarghat(i,theta,sim)[[1]]) 
  # heures minimales travailles qui maximisent l'utilite
  position <- which(u==max(u,na.rm=T)) #utilite maximale
  h<-min(lsup[position])
  return(h) 
}

#calcule le nombre d'heures optimales pour les n individus selon les paramètres

simwork<- function(theta, sim){
  individus <- c(1:n)
  whsim <- sapply(individus,function(x) Lhat(x,theta,sim))
  return(whsim)
}

```


## Méthode des moments généralisés simulés

Nous allons calibrer le modèle théorique avec les données du *LFS*. Essentiellement, il s'agit de trouver les valeurs de $\theta$ afin que les heures travaillées simulées par le modèle d'offre de travail basé sur la théorie économique soient le plus près possible des données observées dans le *LFS*. Pour ce faire, nous utilisons la méthode des moments généralisés, qui consiste à fixer certains paramètres de la distribution, comme la moyenne et l'écart-type, et à sélectionner les valeurs de $\theta$ qui reproduisent ces *moments.* 

Comme la population du sondage est diversifiée et que les caractéristiques individuelles influencent fortement les préférences pour le loisir, il faut inclure plusieurs variables dans le modèle. Dans ce cas, il y a plusieurs combinaisons de $\theta$ qui permettent de répliquer la moyenne et l'écart-type des heures travaillées. On dit que le modèle est *sous-identifié*. Pour que le modèle soit identifié, il nous faut au minimum autant de moments que de paramètres à estimer. En multipliant le vecteur des heures travaillées par la matrice des caractéristiques individuelles, on obtient facilement des moments intuitifs.

Le code suivant génère les moments réels observés dans l'échantillon en prenant soin de pondérer les moyennes et l'écart-type, puisque les individus ne sont pas également représentatifs de la population.

```{r}
rhours <- as.numeric(lfsqc$ATOTHRS)*weeks # nombre d'heures annuelles sur une base de 'weeks' semaines de travail
wrhours <- rhours*wght # heures annuelles x poids individuels

#Matrice des caractéristiques individuelles
Xmat<-Xmat[,1:5]
k<-ncol(Xmat)

#ecart-type des heures ponderees
rwse <-  sqrt((sum(wght*(rhours^2))/sum(wght))-(sum(wrhours)/sum(wght))^2)
rmoments <- c(colSums(matrix(rep(wrhours,k),n,k)*Xmat)/sum(wght),rwse,sum(as.numeric(rhours>=1750 & rhours<=2000)*wght)/sum(wght),sum(as.numeric(rhours==0)*wght)/sum(wght)) # calcul des moments
print(rmoments)
```

On a donc 8 moments ici:

1. moyenne(heures travaillées)

2. moyenne(heures travaillées $\times$ age)

3. moyenne(heures travaillées -- femme)

4. moyenne(heures travaillées -- >1 enfant préscolaire)

5. moyenne(heures travaillées $\times$ niveau d'éducation)

6. écart-type(heures travaillées)

7. moyenne(travaille entre 35 et 40h / semaine)

8. moyenne(ne travaille pas)


On veut donc choisir une valeur de $\theta$ telle que les moments simulés par le modèle soient proches des moments dans les données. Malgré que nous ayons autant de moments que de paramètres, nous ne pouvons en général pas être certains qu'il existe une unique solution de $\theta$ . C'est pour cela que nous parlons habituellement de *calibration* et non d'*estimation* du modèle. En pratique, la calibration s'opère comme une estimation classique, i.e. nous allons minimiser la distance entre les moments simulés et les moments observés:

$$
GMM(\theta)=(\mathbb{E}Moments(\theta)-Moments)'(\mathbb{E}Moments(\theta)-Moments)
$$
où $\mathbb{E}Moments(\theta)$ est la moyenne des moments simulés pour différents tirages des $\varepsilon_i$ et $Moments$ sont les moments des données. La procédure est donc de minimiser $GMM(\theta)$. 


Pour coder l'espérance des 12 moments simulés selon le vecteur de coefficients *theta*, nous utilisons la fonction *simhours*


```{r}
simhours <- function(theta){
  moments <- rep(0,8) # vecteur de zéros qui va contenir la moyenne des moments simulés
  for (sim in 1:nsim){
     hours <- as.numeric(sapply(1:n,function(i) Lhat(i,theta,sim)))
     wh <- wght*hours
     swse <-  sqrt((sum(wght*(hours^2))/sum(wght))-(sum(wh)/sum(wght))^2)
     moments <- moments + c(colSums(matrix(rep(wh,k),n,k)*Xmat)/sum(wght),swse,sum(as.numeric(hours>=1750&hours<=2000)*wght)/sum(wght),sum(as.numeric(hours==0)*wght)/sum(wght)) # calcul des moments     
  }
  moments <- moments/nsim # fait la moyenne
  return(moments)
}

distrhours <- function(theta){
  moments <- simhours(theta) # moments simulés
  gmm <- sum((moments-rmoments)^2) # distance entre les moments simulés et les moments dans les données
  return(gmm)
}
```


On peut donc maintenant lancer la calibration. L'objectif de la calibration est de minimiser la somme du carré des écarts entre  les moments simulés *moments* et les moments observés *rmoments*. L'optimisation de la fonction *distrhours* qui calcule les GMM se fait par la fonction *optim* qui cherche les valeurs de *theta* qui minimisent la fonction. Nous donnons un vecteur de départ arbitraire *thetahat* et l'algorithme d'optimisation retourne le vecteur de *thetahat* qui minimise les GMM. 

```{r}
#Valeurs     de départ inspirés des paramètres de Clavet, Duclos et Lacroix
thetastart <- c( 102, -59 ,  8, 0.5 ,  100  ,11,
              1.3, 4 , 0.01  , 5, 2 , 10)

distrhours(thetastart) #gmm de depart

# #Calibration - ne pas rouler, ca prend 16 h....
# out <- optim(thetastart, fn=distrhours) # minimise la fonction gmmfct prenant theta comme valeur de départ.
# thetatry <- out$par
# print(out)

#Parametres estimes par la calibration
thetatry <-c(  41.607398,  40.045893, -1.648033, -103.284407, 26.623463,  56.483046,
             -10.824611,   63.101435, 124.403127, -28.121906, 12.512040 ,  24.094047)
#Ajustement a la main des parametres pour reduire l'ecart entre les moments
thetatry[5] <- thetatry[5]-6
thetatry[10]<- thetatry[10]+160
thetatry[11]<-thetatry[11]
thetatry[12] <- thetatry[12]-13

distrhours(thetatry) # gmm finaux
```

## Résultats de la calibration

On voit la valeur calibrée de theta dans $out\$ par$ et la valeur de la fonction objective dans $out\$ value$. On peut maintenant voir les moments simulés (moyenne sur *nsim* simulations) et les moments réels avec le code suivant:

```{r }
print(thetatry) # parametres finaux
print(simhours(thetatry)) # moments simules
print(rmoments) #moments observes
```

On voit donc que la majorité des moments sont bien simulés, sauf que modèle produit un moindre taux de chômage et une plus grande variance des heures travaillées. 
Voici la distribution des heures travaillées observées et simulées: 

```{r}
hist(rhours, main = "Distribution des heures observées",
     ylab = "Fréquence",
     xlab = "Heures annuelles")

```

On voit bien la masse importante juste avant 2000 heures de travail (i.e. 40 heures par semaine pendant 50 semaines), ce qui est intuitivement clair. Le code suivant nous donne un exemple de distribution des heures travaillées données par le modèle.

```{r}
hres0<-simwork(thetatry, nsim)
hist(hres0, main = "Distribution des heures simulées, scénario de base",
     ylab = "Fréquence",
     xlab = "Heures annuelles")
```

## Résultats du scénario de base 

Pour l'instant, la valeur estimée de $\theta$ nous donne une distribution des heures travaillées, ce qui nous permet de calculer les taxes, le bien-être et beaucoup d'autres variables. La matrice *stats0* contient les vecteurs d'heures de travail, d'utilité, de revenu brut, de taxes et transferts et de revenu brut pour les `r n` individus (moyennen sur `r nsim` simulations). 

```{r}
makestats <- function(theta){
   stats_var <- matrix(0,n,5)
   for (sim in 1:nsim){
     h <- simwork(theta,sim)
     inc <- h*wage
     t <- sapply(1:n,function(i) itax(h[i]*wage[i], i)[1])
     u <- sapply(1:n, function(i) Utilite(i,h[i],theta))
     Ynet <- sapply(1:n, function(i) Y(i, h[i]))
     stats_var[,1] <- stats_var[,1] + (h)/nsim
     stats_var[,2] <- stats_var[,2] +(u)/nsim
     stats_var[,3] <- stats_var[,3] +(inc)/nsim
     stats_var[,4] <- stats_var[,4] +(t)/nsim
     stats_var[,5] <- stats_var[,5] + (Ynet)/nsim
   }
   return(stats_var)
}
stats0 <- makestats(thetatry)
colnames(stats0) <- c("heures travaillées","utilité","revenu brut","taxes et transferts", "revenu net")
kable(summary(stats0))
```

```{r include=FALSE}
outtme0 <- tme(100,250000,1)
```

```{r}
par(mfrow=c(2,2))
hist(stats0[,1], main = "Distribution des heures travaillées", 
     ylab = "Fréquence", xlab = "Heures annuelles")
hist(stats0[,3],  col=bleupale, main = "Distribution des revenus",
     ylab = "Fréquence", xlab = "Revenu ($)")
legend("right", legend=c("Revenu brut", "Revenu net"),
       fill=c(bleupale, bleumoyen), cex=0.8)
hist(stats0[,5], col=bleumoyen, add=T)
plot(outtme0[[1]], outtme0[[2]], main = "TMEI, réforme 0", type = "l", lty = 1, 
     ylim = c(0,1.5), xlab = "Revenu", ylab = "TMEI")
```

Calcul du coefficient de Gini sur le revenu net

```{r}
Gini0 <- Gini(x=stats0[,5], n=wght)
print(Gini0)
```

Notre coefficient de Gini pondéré de `r Gini0` est beaucoup plus faible (plus égalitaire) que celui qui est calculé par Statistique Canada, qui était de 0.284 en 2016 (http://qceco.ca/n/3739). Sans avoir à réfléter parfaitement la réalité québécoise, il nous permettra de comparer les réformes au scénario de base (*reforme=0*). 

# 5. Réforme #1: Prime à l'emploi

On a donc une valeur de $\theta$ qui permet de répliquer les moments observés dans les données et de donner quelques statistiques descriptives de l'économie simulée. On peut donc maintenant commencer à faire des analyses de réformes.

La prime à l’emploi est de 3$/h pour tout individu ayant trouvé un emploi et travaillant au moins 30h par semaine. La prime commence à s’appliquer à 30h de travail durant la semaine. Elle est prise de l’article de Clavet et al. (2013). De cet article, les auteurs font l’hypothèse que la stimulation de l’emploi est la meilleure façon de sortir les agents de la pauvreté matérielle. Ce type d’aide aux travailleurs aura pour effet, théoriquement, d’encourager davantage la participation au travail des individus ayant les plus faibles salaires horaires.
Encore une fois les détails de la réforme sont codés dans la fonction `transferts`. Elle assume que les transferts habituels sont maintenus, à l’exception de la prime pour les travailleurs (basée sur le salaire annuel) qui est remplacée par la prime au travail (subvention de 3$ de l’heure). 
```{r}
reforme <- 1
```

### Modification des TMEI:

Pour un couple avec enfant (modifier le 3e terme *i* pour obtenir les TMEI des autres types de ménages):

```{r }
outtme1 <- tme(100,250000,1)
```

## Simulations du modèle d'offre de travail
On peut donc utiliser le modèle pour voir les changements anticipés sur les valeurs des moments.

```{r}
print(simhours(thetatry))
```

On peut aussi voir les autres statistiques prédites:

```{r}
stats1 <- makestats(thetatry)
colnames(stats1) <- c("heures travaillées","utilité","revenu brut","taxes et transferts", "revenu net")
kable(summary(stats1))
```

En particulier, ici on voit que tous se sont mis à travailler. C'est une conséquence directe de l'hypothèse sur l'utilité: sans aide sociale, ne pas travailler implique une consommation nulle et une utilité de -Infini. Les individus sont donc prêts à tout pour arriver à consommer. 

Voici l'histogramme des heures travaillées et des revenus nets.

```{r}
par(mfrow=c(2,2))
hist(stats1[,1], main = "Distribution des heures travaillées", 
     ylab = "Fréquence", xlab = "Heures annuelles")
hist(stats1[,3],  col=bleupale, main = "Distribution des revenus",
     ylab = "Fréquence", xlab = "Revenu ($)")
legend("right", legend=c("Revenu brut", "Revenu net"),
       fill=c(bleupale, bleumoyen), cex=0.8)
hist(stats1[,5], col=bleumoyen, add=T)
plot(outtme1[[1]], outtme1[[2]], main = "TMEI, réforme 1", type = "l", lty = 1, 
     ylim = c(0,1.5), xlab = "Revenu", ylab = "TMEI")
```

Calculons le coefficient de Gini pour la réforme 1: 

```{r}
Gini1 <-Gini(x=stats1[,5], n=wght)
Gini1
```


# 6. Réforme #2 : Revenu minimum garanti

## Nouvelles règles fiscales

La réforme fiscale via le revenu minimum garanti est inspirée de celle proposée par Boccanfuso, Cousineau et Fonseca (2020). Inversement à l'aide sociale, son caractère universel ne crée pas de mur pour les individus qui en bénéficient et qui désirent travailler. 
Pour les personnes qui ont 20 ans et plus, le revenu minimum garanti correspond a 55% du panier de consommation annuel, évalué à 36970.44 dollars en 2020 pour Montréal (le plus élevé de la province). Le panier de consommation est évalué en dollars constants de 2018 (Données du Tableau 11-10-0066-01 de Statistiques Canada, pondéré via un ratio calculé à l’aide des données du tableau 11-10-0224-01 de Statistiques Canada). Pour les personnes de 65 ans et plus, le revenu minimum garanti correspond à 100% du panier de consommation de 36970.44 dollars. Les règles fiscales de l’attribution des paniers sont déjà codées dans la fonction transferts. Elles consistent à attribuer universellement un revenu minimum garanti correspondant à un pourcentage du panier de consommation selon le type de ménage et l’âge. Les autres transferts ont tous été retirés, incluant l’aide sociale.

````{r}
reforme <- 2
````

### Modification des TMEI:

Pour un couple avec enfant (modifier le 3e terme *i* pour obtenir les TMEI des autres types de ménages):

```{r }
outtme2 <- tme(100,250000,1)
```

## Simulations du modèle d'offre de travail

On peut donc utiliser le modèle pour voir les changements anticipés sur les valeurs des moments de la réforme 2.


```{r}
print(simhours(thetatry))
```
Beaucoup plus de gens ne travaillent pas.
 
On peut aussi voir les autres statistiques prédites:

```{r}
stats2 <- makestats(thetatry)
colnames(stats2) <- c("heures travaillées","utilité","revenu brut","taxes et transferts", "revenu net")
kable(summary(stats2))
```

En particulier, ici on voit que tous se sont mis à travailler. C'est une conséquence directe de l'hypothèse sur l'utilité: sans aide sociale, ne pas travailler implique une consommation nulle et une utilité de -Infini. Les individus sont donc prêts à tout pour arriver à consommer. 

Voici l'histogramme des heures travaillées et des revenus nets.

```{r}
par(mfrow=c(2,2))
hist(stats2[,1], main = "Distribution des heures travaillées", 
     ylab = "Fréquence", xlab  = "Heures annuelles")
hist(stats2[,3],  col=bleupale, main = "Distribution des revenus",
     ylab = "Fréquence", xlab = "Revenu ($)")
legend("right", legend=c("Revenu brut", "Revenu net"),
       fill=c(bleupale, bleumoyen), cex=0.8)
hist(stats2[,5], col=bleumoyen, add=T)
plot(outtme2[[1]], outtme2[[2]], main = "TMEI, réforme 2", type = "l", lty = 1, 
     ylim = c(0,1.5), xlab = "Revenu", ylab = "TMEI")
```

Calculons le coefficient de Gini pour la réforme 2: 

```{r}
Gini2 <-Gini(x=stats2[,5], n=wght)
Gini2
```


# 7. Réforme #3: Combinaison de RMG et prime à l'emploi

Dans cette réforme, nous combinons les réformes 1 et 2, soient un revenu minimum garanti et une prime au travail. Tous les autres transferts, incluant l'aide sociale sont supprimés. 

```{r}
reforme <- 3
```

### Modification des TMEI:

Pour un couple avec enfant (modifier le 3e terme *i* pour obtenir les TMEI des autres types de ménages):

```{r}
outtme3 <- tme(100,250000,1)
```

## Simulations du modèle d'offre de travail
On peut donc utiliser le modèle pour voir les changements anticipés sur les valeurs des moments.

```{r}
print(simhours(thetatry))
```

On peut aussi voir les autres statistiques prédites:

```{r}
stats3 <- makestats(thetatry)
colnames(stats3) <- c("heures travaillées","utilité","revenu brut","taxes et transferts", "revenu net")
summary(stats3)
```

 

Voici l'histogramme des heures travaillées et des revenus nets.

```{r}
par(mfrow=c(2,2))
hist(stats3[,1], main = "Distribution des heures travaillées", 
     ylab = "Fréquence", xlab  = "Heures annuelles")
hist(stats3[,3],  col=bleupale, main = "Distribution des revenus",
     ylab = "Fréquence", xlab = "Revenu ($)")
legend("right", legend=c("Revenu brut", "Revenu net"),
       fill=c(bleupale, bleumoyen), cex=0.8)
hist(stats3[,5], col=bleumoyen, add=T)
plot(outtme3[[1]], outtme3[[2]], main = "TMEI, réforme 3", type = "l", lty = 1, 
     ylim = c(0,1.5), xlab = "Revenu", ylab = "TMEI")
```

Calculons le coefficient de Gini pour la réforme 3: 

```{r}
Gini3 <-Gini(x=stats3[,5], n=wght)
Gini3
```

# 8. Comparaisons des réformes

Les réformes sont comparées sur la base des heures travaillées:

```{r fig47, fig.width = 6, fig.height=6}
# graphiques en violon
vioplot(stats0[,1],
        stats1[,1],
        stats2[,1],
        stats3[,1], names = c("De base",  "PT","RMG", "RMG et PT"),
        col=c("magenta4", "dark turquoise", "seagreen", "blue2"), lty="blank",
        horizontal = T, 
        xlab = "Heures travaillées annuelles",
        main = "Distribution des heures travaillées")



```

Voici l'effet sur les revenus nets:

```{r fig48, fig.width = 6, fig.height=6}
#  graphiques en violon
vioplot(stats0[,5],
        stats1[,5],
        stats2[,5],
        stats3[,5], names = c("De base",  "PT","RMG", "RMG et PT"),
        col=c("magenta4", "dark turquoise", "seagreen", "blue2"), lty="blank",ylim = c(0, 150000),
        xlab = "Revenu net annuel ($)",
        horizontal = TRUE,
        main = "Distribution des revenus nets annuels")

```

Voici l'effet sur les taux marginaux effectifs d'imposition:

```{r}
plot(outtme0[[1]], outtme0[[2]], main = "TMEI, ensemble des réformes", type = "l", lty = 2,lwd=2, 
     col= "magenta4",      ylim = c(0,1), xlab = "Revenu", ylab = "TMEI")
lines(outtme1[[1]], outtme1[[2]], type = "l", lty = 2, lwd=2, col= "dark turquoise")
lines(outtme2[[1]], outtme2[[2]], type = "l", lty = 1, col= "seagreen")
lines(outtme3[[1]], outtme3[[2]], type = "l", lty = 1, col= "blue2")
legend("bottomright", legend=c("De base", "Prime travail", "Revenu minimum garanti", "RMG et PT"),
       col=c("magenta4", "dark turquoise", "seagreen", "blue2"), lty=c(2,2,1,1), cex=0.8, box.lty=0)
```

Variations de l'indice de Gini, pondéré pour les poids populationnels

```{r, fig49,fig.width = 4.5, fig.height=3 }
listeGini <- c(Gini0, Gini1, Gini2, Gini3)
barplot(listeGini,
        names.arg=c("De base",  "PT", "RMG","RMG et PT"),
        col=c("magenta4", "dark turquoise", "seagreen", "blue2"), ylim = c(1, 0.25),border=NA)
```

## Conclusions
En bref, 

# Bibliographie 

BOCCANFUSO, Dorothée, COUSINEAU, Jean-Michel, FONSECA, Raquel, Le revenu minimum garanti : une utopie? Une inspiration pour le Québec, sommaire, rapport final du comité d'experts sur le revenu minimum garanti, Ministère du travail, de l'emploi et de la solidarité sociale, 2017, document disponible à l'adresse < https://www.mtess.gouv.qc.ca/grands-dossiers/revenu_min_garanti.asp >, consulté le 27 mars 2020

CLAVET, Nicholas-James, DUCLOS, Jean-Yves, LACROIX, Guy, Fighting Poverty: Assessing the effect of guaranteed minimum income proposal in Quebec, project muse, University of Toronto Press, Canadian Public Policy, volume 39, no. 4, 2013, p. 491-516, article accessible à l'adresse < https://www.utpjournals.press/doi/abs/10.3138/CPP.39.4.491 >, consulté le 25 mars 2020

BLANCQUAERT, Arnaud, CLAVET, Nicholas-James, DUCLOS, Jean-Yves, FORTIN, Bernard, MARCHAND, Steeve, Taux marginaux effectifs d'imposition: une comparaison Québec-Ontario, Actualité économique,  revue d'analyse économique, vol.93, no. 4, 2017, p. 532-558, article accessible à l'adresse < http://expertise.hec.ca/actualiteeconomique/wp-content/uploads/2018/01/93_4_blancquaert_clavet_duclos_fortin_marchand.pdf >, consulté le 29 mars 2020

HURTEAU, Philippe, LABRIE, Vician, NGUYEN, Minh, Le revenu viable 2019 et les situations de pauvreté, Données pour différentes localités du Québec, IRIS, note socioéconomique, 2019, article accessible à l'adresse < https://iris-recherche.qc.ca/publications/revenuviable2019 >, consulté le 8 avril 2020

Chaire en fiscalité et finances publiques, Crédit d'impôt pour la TPS/TVH, École de gestion de l'Université de Sherbrooke, 2019, article accessible à l'adresse < https://cffp.recherche.usherbrooke.ca/outils-ressources/guide-mesures-fiscales/credit-impot-tps-tvh/ >, consulté le 8 avril 2020

 Chaire en fiscalité et en finances publiques, Allocation canadienne pour enfants, École de gestion de l'Université de Sherbrooke, 2019, article accessible à l'adresse < https://cffp.recherche.usherbrooke.ca/outils-ressources/guide-mesures-fiscales/allocation-canadienne-enfants/ >, consulté le 8 avril 2020

Chaire en fiscalité et en finances publiques, Allocation famille, École de gestion de l'Université de Sherbrooke, 2019, article accessible à l'adresse < https://cffp.recherche.usherbrooke.ca/outils-ressources/guide-mesures-fiscales/allocation-famille-soutien-enfants/ >, consulté le 8 avril 2020

Chaire en fiscalité et en finances publiques, Crédit d'impôt pour solidarité, École de gestion de l'Université de Sherbrooke, 2019, article accessible à l'adresse < https://cffp.recherche.usherbrooke.ca/outils-ressources/guide-mesures-fiscales/credit-impot-solidarite/ >, consulté le 8 avril 2020

Chaire en fiscalité et en finances publiques, Allocation canadienne pour les travailleurs, École de gestion de l'Université de Sherbrooke, 2020, article accessible à l'adresse < https://cffp.recherche.usherbrooke.ca/outils-ressources/guide-mesures-fiscales/allocation-canadienne-pour-les-travailleurs/ >, consulté le 8 avril 2020

Cirano, Évolution du coefficient de Gini, revenu disponible ajusté, Le Québec économique, 2020, données accessible à l’adresse <https://qe.cirano.qc.ca/theme/revenus-inegalites/inegalites/graphique-evolution-coefficient-gini-revenu-disponible-ajuste >, consulté le 28 mars 2020

Gouvernement du Canada, Les taux d'imposition canadiens pour les particuliers - années courante et années passées, 2020, données accessibles à l'adresse < https://www.canada.ca/fr/agence-revenu/services/impot/particuliers/foire-questions-particuliers/taux-imposition-canadiens-particuliers-annee-courante-annees-passees.html#federal >, consulté le 8 avril 2020 

Gouvernement du Québec, Programme d'aide sociale, Services Québec - Citoyens, s'installer au Québec, Ministère du travail, de l'emploi et de la solidarité sociale, données accessibles à l'adresse < http://www4.gouv.qc.ca/FR/Portail/Citoyens/Evenements/immigrer-au-quebec/Pages/programme-aide-sociale.aspx >, consulté le 8 avril 2020 

Gouvernement du Québec, Crédit d'impôt pour solidarité, Services Québec -Citoyens, Propriétaires d'une habitation, 2020, données accessibles à l'adresse < http://www4.gouv.qc.ca/FR/Portail/Citoyens/Evenements/acheter-renover-maison/Pages/credit-impot-pour-solidarite.aspx >, consulté le 8 avril 2020

NRG CPA inc., Déductions à la source et charges sociales, 2020, données disponibles à l'adresse < http://www.nrgcpa.ca/deductions-a-la-source-et-charges-sociales >, consulté le 8 avril 2020

Revenu Québec, Taux d'imposition, 2020, données accessibles à l'adresse < https://www.revenuquebec.ca/fr/citoyens/declaration-de-revenus/produire-votre-declaration-de-revenus/taux-dimposition/ >, consulté le 8 avril 2020 

Revenu Québec, Crédits d'impôt relatifs à la prime au travail, 2020, données accessibles à l'adresse < https://www.revenuquebec.ca/fr/citoyens/credits-dimpot/credits-dimpot-relatifs-a-la-prime-au-travail/ >, consulté le 8 avril 2020 

Statistique Canada, Labour Force Survey, February 2020 [Canada], Labour Statistic division, Canada, 2020, les données sont accessible par l’adresse <http://odesi2.scholarsportal.info.acces.bibl.ulaval.ca/webview/ >,  consulté le 25 mars 2020

Statistique Canada, Tableau 11-10-0066-01, Seuil de la Mesure du panier de consommation (MPC) pour famille de référence selon la région de la Mesure du panier de consommation, la composante et l'année de basei, données accessibles à l'adresse < https://www150.statcan.gc.ca/t1/tbl1/fr/tv.action?pid=1110006601 >, consulté le 8 avril 2020 

Statistique Canada, Tableau 11-10-0224-01, Dépenses des ménages selon le type de ménage, données accessibles à l'adresse < https://www150.statcan.gc.ca/t1/tbl1/fr/tv.action?pid=1110022401 >, consulté le 8 avril 2020

Statistique Canada, Tableau 18-10-0004-13, Indice des prix à la consommation selon le groupe de produits, données mensuelles, variation en pourcentage, non désaisonnalisées, Canada, provinces, Whitehorse, Yellowknife et Iqaluit, données accessibles à l'adresse < https://www150.statcan.gc.ca/t1/tbl1/fr/tv.action?pid=1810000413 >, consulté le 8 avril 2020 
